<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFT Event Ticketing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      background: #121212;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1f1f1f;
      padding: 20px;
      text-align: center;
    }
    h1 {
      margin: 0;
    }
    .container {
      max-width: 600px;
      margin: 30px auto;
      padding: 20px;
      background: #1e1e1e;
      border-radius: 10px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 5px;
      border: none;
    }
    input {
      background: #2c2c2c;
      color: white;
    }
    button {
      background: #4caf50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    #status {
      margin-top: 15px;
      color: lightgreen;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <header>
    <h1>NFT Event Ticketing System</h1>
    <button onclick="connectWallet()">Connect Wallet</button>
  </header>

  <div class="container">
    <h2>Create Event</h2>
    <input id="eventName" placeholder="Event Name">
    <input id="ticketPrice" placeholder="Ticket Price (in MATIC)">
    <input id="totalTickets" placeholder="Total Tickets">
    <button onclick="createEvent()">Create Event</button>

    <h2>Buy Ticket</h2>
    <input id="eventId" placeholder="Event ID to buy">
    <button onclick="buyTicket()">Buy Ticket</button>

    <div id="status"></div>
  </div>

  <!-- Use Ethers v5 (v6 may cause breaking changes) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script>
    let provider, signer, contract;

    const contractAddress = "0x366a5265aC81C35efA06133A0f2EaC3c770225ce"; // Replace if needed
    const abi = [
      {
        "inputs":[{"internalType":"uint256","name":"eventId","type":"uint256"}],
        "name":"buyTicket","outputs":[],"stateMutability":"payable","type":"function"
      },
      {
        "inputs":[
          {"internalType":"string","name":"name","type":"string"},
          {"internalType":"uint256","name":"price","type":"uint256"},
          {"internalType":"uint256","name":"totalTickets","type":"uint256"}],
        "name":"createEvent","outputs":[],"stateMutability":"nonpayable","type":"function"
      },
      {
        "inputs":[{"internalType":"uint256","name":"eventId","type":"uint256"}],
        "name":"getEvent","outputs":[
          {"internalType":"string","name":"","type":"string"},
          {"internalType":"uint256","name":"","type":"uint256"},
          {"internalType":"uint256","name":"","type":"uint256"},
          {"internalType":"uint256","name":"","type":"uint256"},
          {"internalType":"address","name":"","type":"address"}],
        "stateMutability":"view","type":"function"
      }
    ];

    async function connectWallet() {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, abi, signer);
        document.getElementById("status").innerText = "✅ Wallet connected";
        console.log("Wallet connected");
      } else {
        alert("Please install MetaMask!");
      }
    }

    async function createEvent() {
      if (!contract) {
        alert("Connect wallet first!");
        return;
      }
      const name = document.getElementById("eventName").value;
      const price = document.getElementById("ticketPrice").value;
      const total = document.getElementById("totalTickets").value;

      try {
        const tx = await contract.createEvent(
          name,
          ethers.utils.parseEther(price),
          parseInt(total)
        );
        document.getElementById("status").innerText = "Creating event...";
        await tx.wait();
        document.getElementById("status").innerText = "✅ Event created!";
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "❌ Failed to create event.";
      }
    }

    async function buyTicket() {
      if (!contract) {
        alert("Connect wallet first!");
        return;
      }
      const eventId = document.getElementById("eventId").value;

      try {
        const eventData = await contract.getEvent(eventId);
        const ticketPrice = eventData[1]; // price is second item

        const tx = await contract.buyTicket(eventId, {
          value: ticketPrice
        });
        document.getElementById("status").innerText = "Buying ticket...";
        await tx.wait();
        document.getElementById("status").innerText = "✅ Ticket purchased!";
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "❌ Failed to buy ticket.";
      }
    }
  </script>

</body>
</html>
